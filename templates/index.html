{% extends "layout.html" %}

{% block title %}Inicio - Gestión de Clientes{% endblock %}

{% block content %}
<h1 class="my-4" style="margin-bottom: 0;">Clientes</h1>
<form method="GET" action="/" class="d-flex mb-2">
    <input class="form-control me-2" type="text" name="query" placeholder="Buscar cliente">
    <button class="btn btn-outline-success" type="submit">Buscar</button>
</form>
<a href="/add_client" class="btn btn-primary mb-2">Añadir Cliente</a>

{% if negative_clients %}
<div class="alert alert-danger mb-2">
    <h4>Clientes con saldo negativo:</h4>
    <ul>
        {% for client in negative_clients %}
        <li>{{ client.name }}: {{ client.balance }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="table-responsive">
    {% if chart_data.labels %}
    <canvas id="balanceChart" class="mb-2" style="max-height: 300px;"></canvas>
    {% endif %}
    <table class="table table-striped table-hover mb-0">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Email</th>
                <th>Saldo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% if clients %}
                {% for client in clients %}
                <tr>
                    <td>{{ client.name }}</td>
                    <td>{{ client.email }}</td>
                    <td>{{ client.balance }}</td>
                    <td>
                        <a href="/client/{{ client.id }}" class="btn btn-info btn-sm me-1">Ver</a>
                        <form method="POST" action="/client/{{ client.id }}/delete" style="display:inline;">
                            <button class="btn btn-danger btn-sm" onclick="return confirm('¿Estás seguro de eliminar este cliente?')">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="4" class="text-center">No hay clientes registrados.</td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

{% if chart_data.labels %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ctx = document.getElementById('balanceChart').getContext('2d');
        const data = JSON.parse(`{{ chart_data | tojson | safe }}`); // Serialización segura
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Saldo Adeudado',
                    data: data.values,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });
    });
</script>
{% endif %}
{% endblock %}